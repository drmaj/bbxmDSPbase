#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "dspProcess.h"

const int BL = 512;
const short B[512] = {
        0,      0,      0,      0,      0,      0,      0,      0,      0,
        0,      0,     -1,      1,     -1,      0,      0,      0,      0,
       -1,      1,     -1,      1,     -1,      0,      0,     -1,      1,
       -1,      2,     -1,      1,      0,      0,      1,     -2,      2,
       -2,      2,     -1,      0,      1,     -2,      2,     -3,      3,
       -3,      2,     -1,     -1,      2,     -3,      4,     -4,      4,
       -3,      1,      1,     -3,      4,     -5,      5,     -5,      3,
       -1,     -1,      4,     -6,      7,     -7,      6,     -4,      2,
        2,     -5,      7,     -9,      9,     -8,      5,     -2,     -2,
        6,     -9,     11,    -11,     10,     -7,      2,      3,     -7,
       11,    -14,     14,    -12,      8,     -3,     -3,      9,    -14,
       17,    -17,     15,    -10,      4,      4,    -11,     17,    -21,
       21,    -19,     13,     -5,     -5,     14,    -21,     25,    -26,
       22,    -15,      6,      6,    -16,     25,    -30,     31,    -27,
       18,     -7,     -7,     20,    -30,     36,    -37,     32,    -22,
        8,      8,    -23,     36,    -43,     44,    -38,     26,     -9,
      -10,     28,    -43,     51,    -52,     45,    -31,     11,     11,
      -33,     50,    -60,     62,    -53,     36,    -13,    -13,     39,
      -59,     71,    -73,     63,    -43,     15,     16,    -46,     70,
      -84,     86,    -74,     51,    -18,    -19,     54,    -83,     99,
     -102,     88,    -60,     22,     22,    -64,     98,   -118,    120,
     -104,     71,    -26,    -26,     76,   -117,    141,   -144,    125,
      -85,     31,     31,    -92,    140,   -170,    174,   -151,    104,
      -37,    -38,    112,   -172,    208,   -214,    186,   -128,     46,
       48,   -140,    216,   -262,    271,   -237,    164,    -59,    -61,
      181,   -282,    345,   -358,    316,   -220,     81,     84,   -251,
      394,   -489,    515,   -461,    326,   -122,   -130,    396,   -637,
      812,   -884,    821,   -607,    239,    271,   -890,   1575,  -2271,
     2921,  -3468,   3863,  -4070,   4070,  -3863,   3468,  -2921,   2271,
    -1575,    890,   -271,   -239,    607,   -821,    884,   -812,    637,
     -396,    130,    122,   -326,    461,   -515,    489,   -394,    251,
      -84,    -81,    220,   -316,    358,   -345,    282,   -181,     61,
       59,   -164,    237,   -271,    262,   -216,    140,    -48,    -46,
      128,   -186,    214,   -208,    172,   -112,     38,     37,   -104,
      151,   -174,    170,   -140,     92,    -31,    -31,     85,   -125,
      144,   -141,    117,    -76,     26,     26,    -71,    104,   -120,
      118,    -98,     64,    -22,    -22,     60,    -88,    102,    -99,
       83,    -54,     19,     18,    -51,     74,    -86,     84,    -70,
       46,    -16,    -15,     43,    -63,     73,    -71,     59,    -39,
       13,     13,    -36,     53,    -62,     60,    -50,     33,    -11,
      -11,     31,    -45,     52,    -51,     43,    -28,     10,      9,
      -26,     38,    -44,     43,    -36,     23,     -8,     -8,     22,
      -32,     37,    -36,     30,    -20,      7,      7,    -18,     27,
      -31,     30,    -25,     16,     -6,     -6,     15,    -22,     26,
      -25,     21,    -14,      5,      5,    -13,     19,    -21,     21,
      -17,     11,     -4,     -4,     10,    -15,     17,    -17,     14,
       -9,      3,      3,     -8,     12,    -14,     14,    -11,      7,
       -3,     -2,      7,    -10,     11,    -11,      9,     -6,      2,
        2,     -5,      8,     -9,      9,     -7,      5,     -2,     -2,
        4,     -6,      7,     -7,      6,     -4,      1,      1,     -3,
        5,     -5,      5,     -4,      3,     -1,     -1,      3,     -4,
        4,     -4,      3,     -2,      1,      1,     -2,      3,     -3,
        3,     -2,      2,     -1,      0,      1,     -2,      2,     -2,
        2,     -1,      0,      0,     -1,      1,     -2,      1,     -1,
        1,      0,      0,      1,     -1,      1,     -1,      1,      0,
        0,      0,      0,      1,     -1,      1,      0,      0,      0,
        0,      0,      0,      0,      0,      0,      0,      0
};


// implements an fir filter using fir coefficients defined in fdacoefs.h
// in fixed-point
short fir_filter(buffer *xn){
	int j;
	int yn = 0;
	// performs the convolution of xn with B
	for(j=0; j < BL; j++){
		yn += readn(xn,j)*B[j];
	}
	yn = (yn >> 15) & 0xffff; //converts from Q30 to Q15 fixed point
	return (short)yn; // must cast to a 16-bit short for output to ALSA
}

// core dsp block processing
int dspBlockProcess(short *outputBuffer, short *inputBuffer, buffer *xnL, buffer *xnR, int samples, int * filter_on, double * volume){
	int i;
	if(*filter_on == 0) {
		memcpy((char *)outputBuffer, (char *)inputBuffer, 2*samples); // passthru
	}
	else if(*filter_on == 1) {
		for (i=0; i < samples; i+=2){
			push(xnL,inputBuffer[i]); // stores the most recent sample in the circular buffer xn
			push(xnR,inputBuffer[i+1]);
			outputBuffer[i] = (short)(*volume*fir_filter(xnL)); // filters the input and stores it in the left output channel
			outputBuffer[i+1] = (short)(*volume*fir_filter(xnR)); // zeros out the right output channel
		}	
	}
	return DSP_PROCESS_SUCCESS;
}
